<script>
	import dayjs from "dayjs";
	import Icon from '$lib/ui/icon.svelte'
	import {getContext} from "svelte";
	import {tooltip} from "$lib/aciton/tooltip.js";
	export let zoom
	const {open} = getContext('simple-modal')
	import PdfReaderDialog from '../../components/item/item-pdf-reader/pdf-reader-dialog.svelte'
	import RateLabel from '$lib/zoom/rate-label.svelte'
	import isToday from "dayjs/plugin/isToday.js";
	dayjs.extend(isToday)
	import CoursePreviewPopup from '$lib/zoom/course-preview-popup.svelte'
	import Dropdown from '$lib/ui/dropdown3.svelte'
	$: is_today = dayjs(zoom.start_date).isToday()
	$: is_ended = dayjs().isAfter(dayjs(zoom.end_date))
	$: student_id = zoom.students.length ? zoom.students[0].user_id : undefined
	$: is_classroom = zoom.is_big_classroom

	const previewMaterial = async (d) => {
		open(PdfReaderDialog, {
			item_id: d.item_id
		}, {
			padding: 0,
			bg_class: 'transparent',
			width: '100%'
		})
	}
</script>

<div class="p-8 border border-gray-300 w-full bg-white shadow-lg rounded max-w-xl">
	<div class="w-full">
		<div class="text-blue-500 mb-1 text-lg">
			{#if is_classroom}
				<div class="text-purple-500">{zoom.sub_cat}</div>
			{:else}
				<div class="text-blue-500">
					<Dropdown activator_style="inline-block" placement="right" caveat_visible>
						<a slot="activator" href="/students/{student_id}/tutor-group/{zoom.tutor_group_id}">
							{zoom.title.split('(')[0]}
						</a>
						<div class="">
							<CoursePreviewPopup tutor_group_id={zoom.tutor_group_id}/>
						</div>
					</Dropdown>
				</div>
			{/if}
		</div>
		<p class="text-gray-500 text-sm">
			{dayjs(zoom.start_date).format('DD MMM (ddd), h:mma')} - {dayjs(zoom.end_date).format('h:mma')}
<!--			<span class="text-xs font-bold ml-2 bg-gray-100 border border-gray-300 px-1">{$zoom_store.time_zone.label}</span>-->
		</p>
		<div class="my-4">
			{#if zoom.days.length}
				{#each zoom.days as d}
					<div class="relative">
						<div use:tooltip={'Preview material'} on:click={() => {previewMaterial(d)}} class="cursor-pointer hover:text-blue-700 hover:bg-gray-200 my-2 group px-4 py-3 bg-gray-100 shadow rounded border-gray-300 border">
							<p class="leading-tight">{d.title}</p>
						</div>
						{#if is_ended && !is_classroom}
							<div class="ml-4 absolute -top-3 -right-4">
								<RateLabel {student_id} item_id={d.item_id} rate={d.t_difficulty_rate}/>
							</div>
						{/if}
					</div>
				{/each}
			{:else}
				<div class="text-gray-300 my-2 group px-4 py-3 bg-gray-100 rounded border-gray-300 border">
					No material yet
				</div>
			{/if}
		</div>
		{#if is_classroom}
			{#each zoom.students as s}
				<div class="inline-flex items-center mr-2 bg-blue-200 rounded-full mt-1">
					<div class="w-6 h-6 rounded-full mr-1 cc text-xs bg-blue-500 text-white">{s.level.charAt(0).toUpperCase() + s.level.slice(1)}</div>
					<span class="text-sm pr-2 py-1">{s.nickname}</span>
				</div>
			{/each}
		{:else}
			{#each zoom.students as s}
				<a href="/students/{s.user_id}" class="inline-flex items-center mr-2 bg-blue-200 rounded-full mt-1 overflow-hidden border border-white hover:border-blue-300">
					<div class="w-6 h-6 rounded-full mr-1 cc text-xs bg-blue-500 text-white">{s.level.charAt(0).toUpperCase() + s.level.slice(1)}</div>
					<span class="text-sm py-1">{s.nickname}</span>
					<div class="w-8 cc bg-white h-8 bg-opacity-50 ml-2">
						<Icon name="report" className="w-3.5 text-gray-400 inline-block"/>
					</div>
				</a>
			{/each}
		{/if}
	</div>
	{#if is_today}
		<div class="mt-4">
			<div class="flex items-center">
				<a use:tooltip={'Open lesson material'} href="/zoom/{zoom.wrapper_id}" class="bg-gradient-to-b from-green-500 to-green-700 hover:shadow transition-transform transform hover:-translate-y-0.5 text-white py-1.5 rounded-full flex-1 flex items-center justify-center">
					Start class
				</a>
				<a use:tooltip={'Open zoom application'} href={zoom.zoom_link} class="bg-white border-2 border-blue-500 text-blue-500 rounded-full cc ml-2 w-12 h-12">
					<Icon name="zoom" className="w-8"/>
				</a>
			</div>
		</div>
	{/if}
</div>